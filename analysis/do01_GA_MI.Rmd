---
title: "Analysis script 1"
author: "Brent Rappaport"
date: "`r format(Sys.time(),  '%Y-%m-%d')`"
output:
  pdf_document: default
  html_document:
    df_print: paged
subtitle: Template Rmd
editor_options:
  chunk_output_type: console
toc: yes
---

# About
These are the primary analyses for Brent Rappaport's doctoral dissertation thesis: "Behavioral, neural, and psychiatric correlates of response to social feedback."

# 1. Get Setup
## 1.1. Clear everything & set width
```{r echo=TRUE, results='hide', message=FALSE}
    options(width=80) #Set width
    options(scipen = 999) #Disable scientific notation
    rm(list=ls())     #Remove everything from environment
    cat("\014")       #Clear Console
```

## 1.2. Load Libraries
```{r echo=TRUE, results='hide', message=FALSE}
  renv::restore()     #restore environment
  library(knitr)      #allows rmarkdown files
  library(haven)      #helps import stata
  library(questionr)  #allows lookfor function
  library(broom)      #nice statistical output
  library(here)       #nice file paths
  library(expss)      #labeling variables/values
  library(psych)      #used for statistical analyses
  library(ggplot2)    #creates plots
  library(MASS)       #runs robust linear models
  library(sfsmisc)    #run robust F-test for linear models
  library(MissMech)   #test of MCAR
  library(naniar)     #handle missingness
  library(mice)       #multiple imputation
  library(miceadds)   #adding functions to mice
  library(tidyverse)  #plotting/cleaning, etc.
  library(pander)     #make nice tables
  library(ggpubr)     #make nice graphs
  library(workflowr)  #helps with workflow
```

## 1.3. Get the Working Directory
```{r}
  here()
```

## 1.4. Set seed
   Remember to set your seed AFTER you load libraries
```{r}
     set.seed(919)    #Set seed
```

## 1.5. Load data
Remember to immediately rename and remove. Avoid overwriting old data.
```{r}
      load(file = "./data/DISS_cleaning07.RData")   
      DISS_do01_full <- DISS_cleaning07  ## first create new data
      rm("DISS_cleaning07")             ## remove old data
      
      load(file = "./data/DISS_cleaning06_pca.RData")
      DISS_do02_grandaverage <- DISS_cleaning06_pca
      rm("DISS_cleaning06_pca")
      
      load(file = "./data/DISS_cleaning06_tf2sf1.RData")
      DISS_do02_tf2sf1 <- DISS_cleaning06_tf2sf1
      rm("DISS_cleaning06_tf2sf1")
      
      load(file = "./data/DISS_cleaning06_tf4sf1.RData")
      DISS_do02_tf4sf1 <- DISS_cleaning06_tf4sf1
      rm("DISS_cleaning06_tf4sf1")

      load(file = "./data/DISS_cleaning06_tf7sf1.RData")
      DISS_do02_tf7sf1 <- DISS_cleaning06_tf7sf1
      rm("DISS_cleaning06_tf7sf1")
```      

## 1.6. Subset data
```{r}
measures_list <- c("rewp_r","fn_r","Reward_bias_20","Loss_bias_20","Reward_bias_20_block1","Reward_bias_20_block2","Loss_bias_20_block1","Loss_bias_20_block2","S5cdic_bdi_perc","S5_SIASSPS","T20age","Income_to_Need")
factors_list <- c("sex","PDSIII_Race","PDSIII_Hispanic","S5psychmed_dos")

for (f in factors_list){ 
    eval(parse(text=paste0("DISS_do01_full$",f,"_f <- with(DISS_do01_full, as.factor(",f,"))")))
}

contrasts(DISS_do01_full$sex_f) <- contr.sum(2)
contrasts(DISS_do01_full$PDSIII_Race_f) <- contr.sum(3)
contrasts(DISS_do01_full$PDSIII_Hispanic_f) <- contr.sum(2)
contrasts(DISS_do01_full$S5psychmed_dos_f) <- contr.sum(2)

DISS_do01 <- DISS_do01_full %>% #subset data to only include those that completed Island Getaway task and have T20age
    drop_na(rewp_r, T20age) %>%
    dplyr::select(c(Subid, all_of(measures_list), all_of(factors_list), paste0(factors_list[1:3],"_f")))
```

# 2. Make and plot grand averages
## 2.1. Calculate grand averages
```{r}
# Drop unneeded columns and add Time variable
DISS_do02_grandaverage_time <- DISS_do02_grandaverage %>%
  dplyr::select(-Filename) %>% #remove 'Filename' variable
  mutate(Time=rep(seq(-200,799,2),234)) %>% #create Time variable from -200 to 798 by intervals of 2ms
  dplyr::select(Subid,Condition,Time,everything()) %>% #rearrange data to put Subid, Condition, and Time first
  filter(Time>0) %>% #remove data from pre-stimulus interval (-200 to 0ms)
  arrange(Subid,Condition,Time) %>% #sort by Subid, Condition, and then Time
  group_by(Condition,Time) %>% #grouping required for summarise in the next step
  dplyr::summarise(Cz_ga = mean(Cz),
                   FC2_ga = mean(FC2)) %>% #calculate mean across subjects
  pivot_wider(id_cols=Time, names_from=Condition, values_from=c(Cz_ga,FC2_ga)) #Make data into wide format

DISS_do02_grandaverage_time$Cz_ga_resid <- stdres(lm(Cz_ga_ACC ~ Cz_ga_REJ, DISS_do02_grandaverage_time, na.action=na.exclude))
DISS_do02_grandaverage_time$FC2_ga_resid <- stdres(lm(FC2_ga_ACC ~ FC2_ga_REJ, DISS_do02_grandaverage_time, na.action=na.exclude))
```

## 2.2. Make grand average waveforms
```{r}
cz_ga_plot <- ggplot(data=gather(DISS_do02_grandaverage_time[,c("Time","Cz_ga_ACC","Cz_ga_REJ","Cz_ga_resid")], Type, Feedback, -Time), aes(x=Time, y=Feedback, color=Type)) +
  geom_line(size=1.5) +
  geom_rect(aes(xmin=0, xmax=0, ymin=-4, ymax=11), color="black") +
  geom_rect(aes(xmin=-200, xmax=800, ymin=0, ymax=0), color="black") +
  geom_rect(aes(xmin=294, xmax=394, ymin=-4, ymax=11), fill="grey", alpha=.01, color="white") +
  annotate(geom="text", x=344, y=11.4, label="RewP", color="black", size=8) +
  scale_color_manual(breaks=c("Cz_ga_ACC","Cz_ga_REJ","Cz_ga_resid"),
                     values=c("Cz_ga_ACC"="green", "Cz_ga_resid"="black", "Cz_ga_REJ"="red"), 
                     labels=c("Acceptance","Rejection","Difference"), name=NULL) +
  labs(x="Time (ms)", y="Average Cz activity (µV)") +
  scale_x_continuous(breaks = seq(-200, 800, by = 100)) +
  scale_y_continuous(limits=c(-4,11.5), breaks = seq(-4, 11.5, by = 2)) +
  theme_bw() +
  theme(legend.position = c(0.2, 0.8), legend.text=element_text(size=20), legend.key.size = unit(1.5, 'lines'),
        axis.text=element_text(size=18),
        axis.title=element_text(size=23,face="bold"),
        plot.margin=unit(c(.5,.2,.5,.8), "cm"))
  ggsave("./figures/Figure_2.png", cz_ga_plot, width = 10.5, height = 6.5)
```

## 2.3. Make PCA component waveforms
### 2.3.1. TF2SF1 (RewP)
```{r}
DISS_do02_tf2sf1_ga <- DISS_do02_tf2sf1 %>%
  group_by(Condition,Time) %>% #grouping required for summarise in the next step
  pivot_wider(id_cols=Time, names_from=Condition, values_from=FC2) #Make data into wide format

DISS_do02_tf2sf1_ga$resid <- DISS_do02_tf2sf1_ga$ACC-DISS_do02_tf2sf1_ga$REJ

tf2sf1_ga_plot <- ggplot(data=gather(DISS_do02_tf2sf1_ga[,c("Time","ACC","REJ","resid")], Type, Feedback, -Time), aes(x=Time, y=Feedback, color=Type)) +
  geom_line(size=1.5) +
  geom_rect(aes(xmin=0, xmax=0, ymin=-1, ymax=10), color="black") +
  geom_rect(aes(xmin=-200, xmax=800, ymin=0, ymax=0), color="black") +
  geom_rect(aes(xmin=294, xmax=394, ymin=-4, ymax=11), fill="grey", alpha=.01, color="white") +
  annotate(geom="text", x=344, y=11.4, label="RewP", color="black", size=8) +
  scale_color_manual(breaks=c("ACC","REJ","resid"),
                     values=c("ACC"="green", "resid"="black", "REJ"="red"), 
                     labels=c("Acceptance","Rejection","Difference"), name=NULL) +
  labs(x="Time (ms)", y="Average FC2 activity (µV)") +
  scale_x_continuous(breaks = seq(-200, 800, by = 100)) +
  scale_y_continuous(limits=c(-1,10), breaks = seq(-1, 10, by = 2)) +
  theme_bw() +
  theme(legend.position = c(0.2, 0.8), legend.text=element_text(size=20), legend.key.size = unit(1.5, 'lines'),
        axis.text=element_text(size=18),
        axis.title=element_text(size=20,face="bold"),
        plot.margin=unit(c(.5,.2,.5,.8), "cm"))
```

### 2.3.2. TF4SF1 (P2)
```{r}
DISS_do02_tf4sf1_ga <- DISS_do02_tf4sf1 %>%
  group_by(Condition,Time) %>% #grouping required for summarise in the next step
  pivot_wider(id_cols=Time, names_from=Condition, values_from=Cz) %>% #Make data into wide format
  mutate(resid = ACC-REJ)

tf4sf1_ga_plot <- ggplot(data=gather(DISS_do02_tf4sf1_ga[,c("Time","ACC","REJ","resid")], Type, Feedback, -Time), aes(x=Time, y=Feedback, color=Type)) +
  geom_line(size=1.5) +
  geom_rect(aes(xmin=0, xmax=0, ymin=-1, ymax=10), color="black") +
  geom_rect(aes(xmin=-200, xmax=800, ymin=0, ymax=0), color="black") +
  geom_rect(aes(xmin=294, xmax=394, ymin=-4, ymax=11), fill="grey", alpha=.01, color="white") +
  annotate(geom="text", x=344, y=11.4, label="RewP", color="black", size=8) +
  scale_color_manual(breaks=c("ACC","REJ","resid"),
                     values=c("ACC"="green", "resid"="black", "REJ"="red"), 
                     labels=c("Acceptance","Rejection","Difference"), name=NULL) +
  labs(x="Time (ms)", y="Average Cz activity (µV)") +
  scale_x_continuous(breaks = seq(-200, 800, by = 100)) +
  scale_y_continuous(limits=c(-1,10), breaks = seq(-1, 10, by = 2)) +
  theme_bw() +
  theme(legend.position = c(0.2, 0.8), legend.text=element_text(size=20), legend.key.size = unit(1.5, 'lines'),
        axis.text=element_text(size=18),
        axis.title=element_text(size=20,face="bold"),
        plot.margin=unit(c(.5,.2,.5,.8), "cm"))
```

### 2.3.3. TF7SF1 (N1)
```{r}
DISS_do02_tf7sf1_ga <- DISS_do02_tf7sf1 %>%
  group_by(Condition,Time) %>% #grouping required for summarise in the next step
  pivot_wider(id_cols=Time, names_from=Condition, values_from=Cz) %>% #Make data into wide format
  mutate(resid = ACC-REJ)

tf7sf1_ga_plot <- ggplot(data=gather(DISS_do02_tf7sf1_ga[,c("Time","ACC","REJ","resid")], Type, Feedback, -Time), aes(x=Time, y=Feedback, color=Type)) +
  geom_line(size=1.5) +
  geom_rect(aes(xmin=0, xmax=0, ymin=-0.5, ymax=0.5), color="black") +
  geom_rect(aes(xmin=-200, xmax=800, ymin=0, ymax=0), color="black") +
  geom_rect(aes(xmin=294, xmax=394, ymin=-0.5, ymax=0.5), fill="grey", alpha=.01, color="white") +
  annotate(geom="text", x=344, y=11.4, label="RewP", color="black", size=8) +
  scale_color_manual(breaks=c("ACC","REJ","resid"),
                     values=c("ACC"="green", "resid"="black", "REJ"="red"), 
                     labels=c("Acceptance","Rejection","Difference"), name=NULL) +
  labs(x="Time (ms)", y="Average Cz activity (µV)") +
  scale_x_continuous(breaks = seq(-200, 800, by = 100)) +
  scale_y_continuous(limits=c(-0.5,0.5), breaks = seq(-0.5, 0.5, by = .5)) +
  theme_bw() +
  theme(legend.position = c(0.2, 0.8), legend.text=element_text(size=20), legend.key.size = unit(1.5, 'lines'),
        axis.text=element_text(size=18),
        axis.title=element_text(size=20,face="bold"),
        plot.margin=unit(c(.5,.2,.5,.8), "cm"))
```

### 2.3.4. Facet plots together
```{r}
tfsf_plots <- ggarrange(tf2sf1_ga_plot, tf4sf1_ga_plot,
          labels = c("TF2/SF1", "TF4/SF1"),
          common.legend = TRUE, legend = "bottom",
          label.x=c(.07,.07), label.y=c(.92,.92),
          ncol = 1, nrow = 2)
ggsave("./figures/Figure_3.png", tfsf_plots, width = 10.5, height = 13)
```

# 3. Check for univariate & multivariate outliers
```{r}
#Univariate
apply(DISS_do01[,c(2:5,10:13)], 2, function(x) which(x > (mean(x, na.rm=T)+3*sd(x, na.rm=T)) | x < (mean(x, na.rm=T)-3*sd(x, na.rm=T))))

#Multivariate
data_p <- psych::outlier(DISS_do01[,c("rewp_r","fn_r","Reward_bias_20","Loss_bias_20","S5cdic_bdi_perc","S5_SIASSPS","T20age","sex","Income_to_Need","PDSIII_Race","PDSIII_Hispanic")],plot = T,bad=10,na.rm=T)
rows_to_exclude <- which(pchisq(data_p,df=11,ncp=0,lower.tail = F,log.p = F)<.01)
rows_to_exclude

DISS_do01_nooutliers <- DISS_do01[-rows_to_exclude, ]
length(DISS_do01_nooutliers$Subid)
```

# 4. Missing data
```{r}
sum(complete.cases(DISS_do01$rewp_r)) #number of participants that completed IG with good data

DISS_do01 %>% #missing data for each variable
  dplyr::select(c(measures_list,paste0(factors_list[1:3],"_f"))) %>%
  miss_var_summary(order=FALSE)
```
N=117 completed IG with reasonably clean data. 2 removed for IQ<70. 5 missing BDI/CDI measure (Subids: 100,101,121,199,584), 0 missing SIAS/SPS, 16 missing PILT, 9 missing DOS psychotropic medication use.

## 4.1. Test MCAR
```{r}
TestMCARNormality(DISS_do01[,c(2:5,10:16)], imputation.number=10, imputation.method="Dist.Free", seed=919)
```
The non-parametric test shows that there is not sufficient evidence to rejection MCAR asssumption, therefore data are assumed to be missing completely at random.

## 4.2. Multiple imputation
Conduct multiple imputation using package 'mice' and the following steps outlined here: 
http://dept.stat.lsa.umich.edu/~jerrick/courses/stat701/notes/mi.html
```{r}
md.pattern(DISS_do01[,c(2:5,10:13,18:20)])
DISS_do01.imp <- mice(DISS_do01[,c(2:5,10:13,18:20)], m = 10, method = 'pmm', seed=919) #generate 10 imputed datasets
summary(DISS_do01.imp)

DISS_do01.comp <- complete(DISS_do01.imp, "long", include = TRUE)

DISS_do01.comp$Reward_bias_20.NA <- cci(DISS_do01$Reward_bias_20)
DISS_do01.comp$Loss_bias_20.NA <- cci(DISS_do01$Loss_bias_20)
DISS_do01.comp$S5cdic_bdi_perc.NA <- cci(DISS_do01$S5cdic_bdi_perc)
```

## 4.2.1. Check imputed values
```{r}
# Reward bias
ggplot(DISS_do01.comp, aes(x = .imp, y = Reward_bias_20, color = Reward_bias_20.NA)) + 
  geom_jitter(show.legend = FALSE, width = .2)

# Loss avoidance
ggplot(DISS_do01.comp, aes(x = .imp, y = Loss_bias_20, color = Loss_bias_20.NA)) + 
  geom_jitter(show.legend = FALSE, width = .2)

# Current depression severity
ggplot(DISS_do01.comp, aes(x = .imp, y = S5cdic_bdi_perc, color = S5cdic_bdi_perc.NA)) + 
  geom_jitter(show.legend = FALSE, width = .2)
```


# 5. Standardize measures
Center and standardize all measures to make b estimates from multiple regressions more interpretable.
```{r}
#convert into datlist
DISS_do01.dat <- miceadds::mids2datlist(DISS_do01.imp)
#scale/standardize datlist
DISS_do01.dat_z <- scale_datlist(datlist=DISS_do01.dat, orig_var=measures_list[c(1:4,9:12)], trafo_var=paste0(measures_list[c(1:4,9:12)],"_z"), weights=NULL, M=0, SD=1, digits=NULL)
#convert back to mids
DISS_do01.imp_z <- miceadds::datlist2mids(DISS_do01.dat_z)

#standardize measures in non-imputed dataset (DISS_do01)
for (m in measures_list){
 eval(parse(text=paste0("DISS_do01$",m,"_z <- scale(DISS_do01$",m,", center=T, scale=T)")))
}

#save non-imputed dataset
save(DISS_do01, file="./data/DISS_do01.RData")
#save imputed dataset(s)
save(DISS_do01.imp_z, file="./data/DISS_do01.imp_z.RData")
```

# 3.0 Closing out
  In this step, go ahead and close out of the file and quit R without saving  
  the work space.
```{r}
   renv::snapshot()   #Take a snapshot of environment
```

